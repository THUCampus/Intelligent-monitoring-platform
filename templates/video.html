{% extends 'base.html' %}

{% block header %}
    <h1>{% block title %}监控界面{% endblock %}</h1>
    {% if g.user and g.user['is_manager'] %}
        <a class="action" href="{{url_for('auth.manage')}}">管理员界面</a>
        <a class="action" href="{{url_for('auth.register')}}">注册新用户</a>
        <a class="action" href="{{url_for('criminal.register')}}">逃犯信息录入</a>
    {% endif%}
    <a class="action" href="{{url_for('auth.update_password')}}">修改密码</a>
    <a class="action" href="{{url_for('history_records.manage')}}">历史警示记录</a>
{% endblock %}

{% block content %}
    <form method="post">
        <input type="hidden" name="form_type" value="ip"> {# 提交ip信息 #}
        <label for="ip">IP</label>
        <input name="ip" id="ip" required>
        <input type="submit" value="提交">
    </form>

    <form method="post">
        <input type="hidden" name="form_type" value="task">  {# 提交task类别信息 #}
        <label>识别任务</label>
        <label><input type="radio" name="task" value="object_detection" {% if task == "object_detection" %}checked {% endif %}/>目标识别</label>
        <label><input type="radio" name="task" value="face_recognition" {% if task == "face_recognition" %}checked {% endif %}/>人脸识别（罪犯追踪）</label>
        <label><input type="radio" name="task" value="nothing" {% if task == "nothing" %}checked {% endif %}/>无</label>
        <input type="submit" value="确认上传">
    </form>

    <img src="{{ url_for('video.video_feed') }}" width="900px">

    <h2>最新警示记录</h2>
    <section id="newest_records"></section>

    <script type="text/javascript" src="{{url_for('static', filename='jquery.js')}}"></script>
    <script type="text/javascript">
        var source = new EventSource("{{ url_for('video.records_feed')}}");
        source.onmessage = function (event) {
            var records = jQuery.parseJSON(event.data);
            document.getElementById("newest_records").innerHTML = ""
            for(var i =0; i<records.length; i++){
                document.getElementById("newest_records").innerHTML += "" +
                    "<article class='post'>" +
                        "<header>" +
                            "<div>" +
                                "<h1>" + records[i].criminal_name + "("+records[i].criminal_id+")"+
                                    "在时刻"+records[i].time+"出现在了摄像头"+records[i].camera_id+"</h1>"+
                            "</div>"+
                        "</header>"+
                    "</article>"
            }
        }
    </script>
{% endblock %}